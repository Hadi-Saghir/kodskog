<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        Making the BOSCH Styline TKA8013 Smart - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@hackmd/emojify.js@2.1.0/dist/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
    <style>
        img {
            min-width: 60%;
            max-width: 100%; /* Set the maximum width to 100% of their container (iframe) */
            height: auto; /* Maintain aspect ratio */
        }
        body {
            background-color: #ecf0f3; /* Set the background color to #ecf0f3 */
            color: #1f2937; /* Set text color to #1f2937 */
            font-size: medium;
            text-align: justify;
            letter-spacing: wide; /* Set tracking-wide */
        }
        :root {
        --primary: #ecf0f3;
        --secondary: #1f2937;
        }
        /* Firefox */
        * {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) var(--secondary);
        }

        /* Chrome, Edge, and Safari */
        *::-webkit-scrollbar {
        width: 12px;
        }

        *::-webkit-scrollbar-track {
        background: var(--primary);
        }

        *::-webkit-scrollbar-thumb {
        background-color: var(--secondary);
        /*   background: repeating-linear-gradient(
            45deg,
            var(--secondary),
            var(--secondary) 5px,
            var(--primary) 5px,
            var(--primary) 10px
        ); */
        border-radius: 20px;
        border: 3px solid var(--primary);
        }
      </style>
      
</head>

<body>
    <br>
    <br>
    <br>
    <br>
    <div id="doc" class="markdown-body container-fluid comment-inner comment-enabled" data-hard-breaks="true"><h1 id="Introduction" data-id="Introduction"><a class="anchor hidden-xs" href="#Introduction" title="Introduction"><span class="octicon octicon-link"></span></a><span>Introduction</span></h1><p><strong><span>Name:</span></strong><span> Hadi Saghir</span><br>
<strong><span>Student Credentials:</span></strong><span> hs223um</span></p><p><strong><span>Short Project Overview:</span></strong><br>
<span>This project aims to convert the BOSCH Styline TKA8013 coffee machine into a smart appliance. By leveraging IoT principles and following the course provided roadmap, I will demonstrate proficiency in development environment &amp; device configuration, network connectivity, and data visualization to reach the objectives of my project.</span></p><p><strong><span>Time Estimate:</span></strong><br>
<span>Approximately 4-8 hours, less if you worked with these programs before</span></p><p><img src="https://hackmd.io/_uploads/HkKBov2_3.jpg" alt="w/o LoRa" loading="lazy"></p><h2 id="Objective" data-id="Objective"><a class="anchor hidden-xs" href="#Objective" title="Objective"><span class="octicon octicon-link"></span></a><span>Objective:</span></h2><p><strong><span>What and Why</span></strong><br>
<span>The objective of this project is to showcase how existing appliances, like the BOSCH Styline TKA8013 coffee machine, can be transformed into smart devices while retaining their simplicity, affordability, and user-friendly interface. The functionality that will be added are as follows:</span></p><ol>
<li><span>Brew: Start brewing coffee instantly upon command.</span></li>
<li><span>Brew: Schedule brewing in advance using time or using a preset timer.</span></li>
<li><span>Warm: keep the coffee warm for a certain amount of time</span></li>
<li><span>Warm: keep the coffee warm until manually instructed otherwise.</span></li>
<li><span>Notify: Receive a notification when the coffee is ready to be served.</span></li>
<li><span>Maintenance: Generate a temperature report to ensure the coffee machine maintains optimal brewing temperature.</span></li>
<li><span>Maintenance: Generate a temperature report to ensure the coffee machine maintains highest warm temperature in keep warm mode.</span></li>
</ol><p><strong><span>The Purpose</span></strong><br>
<span>The purpose of this project is simple: Buy the Coffee Machine for its Coffee Making Ability and Make it Smart! we want to avoid unnecessary design complexities and proprietary systems that are often associated with energy-consumption and high prices.</span></p><p><strong><span>Insight</span></strong><br>
<span>This ambitious project has given me invaluable insights into the world of creating a smart and efficient network infrastructure. By incorporating a fully locally-hosted server, I have learned the importance of building a secure and robust network that can accommodate a multitude of devices. This project has opened my eyes to the complexities associated with avoiding unnecessary design complexities and proprietary systems, while still achieving energy efficiency. Through the course syllabus, I have gained a deep understanding of IoT, microcontroller micropython programming, sensor data collection, IoT infrastructure, MQTT messaging protocols, connectivity (LoRaWAN and WiFi), data visualization, time series databases. The hands-on nature of the course has allowed me to develop practical skills in developing an IoT project from conception to implementation.</span></p><h1 id="Getting-Started" data-id="Getting-Started"><a class="anchor hidden-xs" href="#Getting-Started" title="Getting-Started"><span class="octicon octicon-link"></span></a><span>Getting Started</span></h1><p><span>This section will cover the required materials  and computer setup.</span></p><h2 id="Material" data-id="Material"><a class="anchor hidden-xs" href="#Material" title="Material"><span class="octicon octicon-link"></span></a><span>Material</span></h2><p><span>The following materials have been obtained from the following kits:</span></p><ul>
<li><a href="https://www.electrokit.com/produkt/start-kit-applied-iot-at-linnaeus-university-2023/" target="_blank" rel="noopener"><span>LNU Starter kit</span></a><span> (399 SEK)</span></li>
<li><a href="https://www.electrokit.com/produkt/addon-kit-applied-iot-at-linnaeus-university-2023/" target="_blank" rel="noopener"><span>LNU Addon kit</span></a><span> (349 SEK) [Option LoRa]</span></li>
<li><a href="https://www.electrokit.com/produkt/sensor-kit-25-moduler/" target="_blank" rel="noopener"><span>Sensor Kit – 25 modules</span></a><span> (299 SEK)</span></li>
</ul><table>
<thead>
<tr>
<th><span>Type</span></th>
<th><span>Material</span></th>
<th><span>Description</span></th>
</tr>
</thead>
<tbody>
<tr>
<td><span>Sensor</span></td>
<td><span>Photo Resistor</span></td>
<td><span>Analog light measure</span></td>
</tr>
<tr>
<td><span>Sensor</span></td>
<td><span>DH11</span></td>
<td><span>Temperature &amp; Moisture</span></td>
</tr>
<tr>
<td><span>—</span></td>
<td><span>—</span></td>
<td><span>—</span></td>
</tr>
<tr>
<td><span>Actuator</span></td>
<td><span>RGB LED</span></td>
<td><span>Light-emitting diode to simulate state and the press of a button</span></td>
</tr>
<tr>
<td><span>—</span></td>
<td><span>—</span></td>
<td><span>—</span></td>
</tr>
<tr>
<td><span>Connectivity</span></td>
<td><span>M5Stack LoRa module 868MHz</span></td>
<td><span>Optional</span></td>
</tr>
<tr>
<td><span>—</span></td>
<td><span>—</span></td>
<td><span>—</span></td>
</tr>
<tr>
<td><span>Controller</span></td>
<td><span>Raspberry Pi Pico WH</span></td>
<td><span>Microcontroller</span></td>
</tr>
<tr>
<td><span>—</span></td>
<td><span>—</span></td>
<td><span>—</span></td>
</tr>
<tr>
<td><span>Circuit</span></td>
<td><span>Jumpwire</span></td>
<td><span>Male-to-Male and Male-to-Female</span></td>
</tr>
<tr>
<td><span>Circuit</span></td>
<td><span>Breadboard</span></td>
<td><span>840 pins connections</span></td>
</tr>
</tbody>
</table><ol>
<li>
<p><strong><span>Photo Resistor:</span></strong><span> The Photo Resistor is an analog sensor used to measure the intensity of light in the surrounding environment. It provides valuable data for monitoring the state of the coffee machine as the Bosch emits light when on.</span></p>
</li>
<li>
<p><strong><span>DHT11</span></strong><span>: The DHT11 sensor is a versatile component capable of measuring both temperature and humidity levels. It will be used to measure the temperature of the coffee for temperature controll and statistics.</span></p>
</li>
<li>
<p><strong><span>RGB LED</span></strong><span> : the red LED indicates the “off” state, the green LED represents the “on” state, and the blue LED simulates a button press. This approach provides flexibility for users to choose a button press component that suits their machine and avoids the need for additional components beyond those acquired at the beginning of the course, simplifying the implementation. By leveraging the LED’s properties, we visually communicate states: the red LED is off for “off,” the green LED is on for “on,” and the blue LED represents a simulated button press.</span></p>
</li>
<li>
<p><strong><span>M5Stack LoRa module 868MHz:</span></strong><span> This LoRa module operates at a frequency of 868MHz and is designed for long-range, low-bandwidth data transmission. Optional for energy preservation.</span></p>
</li>
<li>
<p><strong><span>Raspberry Pi Pico WH:</span></strong><span> The Raspberry Pi Pico WH is a microcontroller board with built-in headers, making it easy to connect and program. It offers a compact yet powerful platform for controlling and interacting with the various components.</span></p>
</li>
<li>
<p><strong><span>Jumpwire:</span></strong><span> Jumpwires are essential circuit-building components used to establish connections between different parts of an electronic circuit. Male-to-male and male-to-female jumpwires facilitate the flow of signals and power between sensors, actuators, and controllers.</span></p>
</li>
<li>
<p><strong><span>Breadboard:</span></strong><span> A breadboard is a prototyping platform featuring interconnected clips or sockets that allow for the temporary connection of electronic components. It provides a convenient way to assemble and test circuits without soldering, making it ideal for rapid experimentation and design iteration.</span></p>
</li>
</ol><h2 id="Computer-setup" data-id="Computer-setup"><a class="anchor hidden-xs" href="#Computer-setup" title="Computer-setup"><span class="octicon octicon-link"></span></a><span>Computer setup</span></h2><p><span>The project incorporates several services to achieve interoperability of a locally-hosted IoT solution. The software stack includes Thonny as the programming environment for the Pico board, Helium for establishing connectivity, Mosquitto as the MQTT broker, Node-RED as the cloud platform, InfluxDB for database, Grafana for visualization, and Telegram bots  as an interface to the network for remote control of the coffee machine and visualization of data. These services work together to enable seamless integration and functionality across the IoT ecosystem.</span></p><p><span>After multiple attempts that included, but not limited to, semi-locally hosting, hosting services onatively on my Windows computer, using Adafruit, using http, using VMs and dockers containers, the finals version is a fully locally hosted. I have configured using docker-compose with additional setup required.</span></p><ol>
<li>
<p><strong><span>Download Thonny:</span></strong><span> follow the </span><a href="https://hackmd.io/@lnu-iot/SyTPrHwh_" target="_blank" rel="noopener"><span>tutorial</span></a><span> provided by LNU</span></p>
</li>
<li>
<p><strong><span>Update Firmware on Pico:</span></strong><span> follow the </span><a href="https://hackmd.io/@lnu-iot/rkFw7gao_" target="_blank" rel="noopener"><span>tutorial</span></a><span> provided by LNU</span></p>
</li>
<li>
<p><strong><span>Docker:</span></strong></p>
<p><span>Hopefully, I can add more scripts to full fully automate deployment. Follow this </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/Docker%20setup.txt" target="_blank" rel="noopener"><span>tutorial</span></a><span> i created for setting up. I’ve included setup tutorials on how to reconfigure things found below.</span></p>
<p><strong><span>Login credentials</span></strong><span> to Grafana, InfluxDB or Mosquitto/Management center:</span></p>
<ul>
<li><span>username: hadi</span></li>
<li><span>password: Iminyourarea</span></li>
</ul>
<p><strong><span>MQTT Client credential:</span></strong></p>
<ul>
<li><span>username: hadsag</span></li>
<li><span>password: Testuser1</span></li>
</ul>
<p><span>I have configured setup. However, addition configuration is needed. “1DT305_IoT_Project/Docker” has a folder for every service with tutorials/reconfiguration if you dont want me in your area. Set them up in the following order:</span><br>
<span>1. </span><strong><span>Mosquitto</span></strong><span> (</span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/mosquitto/setup.txt" target="_blank" rel="noopener"><span>to complete the setup</span></a><span>, </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/mosquitto/setup.txt" target="_blank" rel="noopener"><span> to reconfigure</span></a><span>)</span><br>
<span>2. </span><strong><span>influxdb</span></strong><span> (</span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/influxdb/setup.txt" target="_blank" rel="noopener"><span>to complete the setup</span></a><span>, </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/influxdb/reconfigure.txt" target="_blank" rel="noopener"><span>to reconfigure</span></a><span>)</span><br>
<span>3. </span><strong><span>Grafana</span></strong><span> (</span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/Grafana/setup.txt" target="_blank" rel="noopener"><span>to complete the setup</span></a><span>, </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/Grafana/reconfigure.txt" target="_blank" rel="noopener"><span>to reconfigure</span></a><span>)</span><br>
<span>4. </span><strong><span>NodeRED</span></strong><span> (</span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/NodeRED/setup.txt" target="_blank" rel="noopener"><span>to complete the setup and import flow</span></a><span>)</span></p>
</li>
<li>
<p><strong><span>Helium (Option LoRa):</span></strong></p>
<ol>
<li><span>Setup Helium (MQTT integration, Function and Flow) can be found on </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Helium/setup.txt.txt" target="_blank" rel="noopener"><span>Git</span></a><span>. The usage of my json format and decoder is optional, but I found their default Json to be verbose and two-dimensional, which is so unnecesaary.</span></li>
</ol>
</li>
</ol><p><span>All code and files can be found in </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project" target="_blank" rel="noopener"><span>Github</span></a></p><h1 id="Assembly" data-id="Assembly"><a class="anchor hidden-xs" href="#Assembly" title="Assembly"><span class="octicon octicon-link"></span></a><span>Assembly</span></h1><p><span>This part will include how to assemble the circuit with the materials mentions above. This includes: “Putting Everything Together”, “Code”, Transmitting the Data"</span></p><h2 id="Putting-Everything-Together" data-id="Putting-Everything-Together"><a class="anchor hidden-xs" href="#Putting-Everything-Together" title="Putting-Everything-Together"><span class="octicon octicon-link"></span></a><span>Putting Everything Together</span></h2><p><span>This section will include who to put the pico together, i.e. hardware. I’m using free software so i had to get a little creative with drawing.</span></p><p><span>OBS! The black is ground and red is the 3V3, some breadboards have different layouts, which can be confusing.</span></p><p><strong><span>Circuit Diagram</span></strong><br>
<img src="https://hackmd.io/_uploads/r1r0-CkKn.png" alt="Diagram" loading="lazy"></p><p><strong><span>Electrical calculation</span></strong></p><p><span>To obtain accurate power consumption values, we need to use power meter. To provide an electrical calculation for this IoT project, I will need to estimate the power consumption of each component with some assumptions based on the </span><a href="https://www.electrokit.com/uploads/productfile/41015/User_guide.pdf" target="_blank" rel="noopener"><span>information provided by electrokit </span></a><span>and browsing the web, we can calculate the following:</span></p><p><span>The power consumption can be calculated by using Ohm’s law: P = V^2 / R</span></p><ol>
<li><span>The </span><strong><span>photo resistor</span></strong><span> module has a resistance of 10 kΩ and operates at 3.3V. P ≈ 0.001 W</span></li>
<li><span>The </span><strong><span>DHT11</span></strong><span> module operates at 3.3V and has a maximum current of 2.5mA. P ≈ 0.3W (active) and 0.06W (idle).</span></li>
<li><span>The </span><strong><span>RGB LED</span></strong><span> module operates at an operating voltage of 5V and three 150Ω limiting resistors. P ≈ 0.5W</span></li>
<li><span>The </span><strong><span>M5Stack LoRa module 868MHz</span></strong><span>  operates at 3.3V or 5V and has a maximum current of 250mA. P ≈ 0.1W to 0.8W, depending on the operating mode, frequency, and transmit power.</span></li>
<li><span>The </span><strong><span>Raspberry Pi Pico WH</span></strong><span> operates at 3.3V or 5V. The maximum current is not specified, but it is recommended to use a power supply that can provide at least 500mA. P ≈ 2.5W or 1W, depends on activity.</span></li>
</ol><p><span>The total power consumption of the circuit can be estimated by adding up the power consumption of each component, assuming they are all operating at the same time:</span></p><p><em><strong><span>P total</span></strong></em><span> = P photoresistor + P DHT11 + PLED + P LoRamodule + P PicoWH</span></p><p><span>Using the </span><strong><span>maximum values</span></strong><span> for each component, we get:</span></p><p><em><strong><span>P total</span></strong></em><span> = 0.001 + 0.3 + 0.5 + 0.8 + 2.5 = </span><strong><span>4.101W</span></strong></p><p><span>Using the </span><strong><span>minimum values</span></strong><span> for each component, we get:</span></p><p><em><strong><span>P total</span></strong></em><span> = 0.001+0.06+0.1+0.1+1 = </span><strong><span>1.271W</span></strong></p><p><span>To achieve lower power consumption, we need to program the Pico to enter deep sleep and idle mode when it is not actively performing tasks or interacting with external components.</span></p><p><span>I watched tests online of the energy efficiency of the pico when in idle and sadly it is not efficient, so i will opt for deepsleep. I decided to make it not a very responsive coffee machine in order to get more energy efficiency. The result I could find are:</span></p><p><strong><span>P active:</span></strong><span> 60mA (WiFi and Pinging MQTT)</span><br>
<strong><span>P idle:</span></strong><span> 39 mA</span><br>
<strong><span>P deepsleep:</span></strong><span> 16 mA</span></p><p><span>I will make the coffee machine deepsleep after the following events.</span></p><ul>
<li><span>Deepsleep from 22 to 8</span></li>
<li><span>Deepsleep 2 hours after brewing and warming</span></li>
<li><span>Deepsleep 20 mins then check for request</span></li>
</ul><h2 id="Platform" data-id="Platform"><a class="anchor hidden-xs" href="#Platform" title="Platform"><span class="octicon octicon-link"></span></a><span>Platform</span></h2><p><span>For this project, I carefully considered various platforms and services to create an efficient and seamless IoT solution. After exploring different options, I made specific choices based on functionality, ease of use, energy efficiency, and personal preferences.</span></p><p><img src="https://hackmd.io/_uploads/SkOXltYuh.png" alt="Platform" loading="lazy"></p><p><strong><span>Helium (Option LoRa):</span></strong><br>
<span>Both Helium and The Things Network offer power-efficient communication and enable long-range connectivity with minimal power consumption. By utilizing LoRaWAN through Helium, the IoT solution can operate on low power, enabling devices to conserve energy effectively.</span></p><p><span>I have setup both but opted for Helium despite the cost disadvantage (1$ for now). Helium offered two two main advantages in my use- case:</span></p><ol>
<li><span>pay-per-use  ensures more reliable and available connectivity, even in lower coverage areas. I was able to join after walking around my apartment a bit.</span></li>
<li><span>The decentralized infrastructure allow for more security, control and scalability, in turn for the cost of setup. For my specific use-case, I was able to integrate my MQTT Endpoint instead of having to use The Network Things own MQTT Service. The other options were very inconvenient, such as webhooks or official cloud providers AWS/Azure. TTN free was very unflexible!</span></li>
</ol><p><img src="https://hackmd.io/_uploads/B1NqDDndh.png" alt="Helium flow" loading="lazy"></p><p><span>I would recommend using your own gateway for privacy, efficiency, and performance. I only have a WiFi gateway, so I tested with providers such as Helium and TTN.</span></p><p><span>OBS! Helium doesn’t natively support SSL, so you have to expose port 1883 (default docker-compose has 1883 open).</span></p><p><span>You can pay to download and host a helium console locally following this </span><a href="https://docs.helium.com/use-the-network/run-a-network-server/run-console/" target="_blank" rel="noopener"><span>tutorial</span></a><span>, but it won’t be covered in this report as I don’t want to pay.</span></p><p><strong><span>MQTT Broker:</span></strong></p><p><span>In terms of messaging protocol, I opted for MQTT (Message Queuing Telemetry Transport) due to its lightweight nature and energy efficiency.</span></p><p><span>I encountered challenges when attempting to use Mosquitto Eclipse on my Windows system. Despite successfully testing the pub-sub test on my local machine, I experienced difficulties when other machines tried to connect. I tried to containerize it using Docker and even setup a Ubuntu VM. I also integrated MQTTExplorer. After investing absurdly significant time and effort into debugging, I switched to HiveMQ for reliable, hassle-free connectivity. HiveMQ provided a more stable, secure (utilizing SSL), and hassle-free experience, ensuring seamless communication between devices. This help decouple Operating System (OS) interference and enables less dependancies for easier replication of the project.</span></p><p><img src="https://hackmd.io/_uploads/By5VcvXd3.png" alt="HiveMQ" loading="lazy"></p><p><span>After finishing the project first draft, I read and watch multiple hours worth of material on docker and network because i didn’t want to have a semi-locally hosted. I finally understood how it works and how i can use docker-compose to create a network bridge between the different containers and how to expose the ports. I containerized all my services and created a decoupled environment for high interoperability and control the network to ensure security and privacy. In addition, I learned learned how to create SSL certificates to ensure maximuim security, so I didn’t compromise on security.</span></p><p><span>I integrated Cedalo Management Center for more convenient management of Mosquitto. However, I wrote a </span><a href="C:%5CUsers%5Chadis%5CDesktop%5CGit%5CIoT%5C1DT305_IoT_Project%5CDocker%5Cmosquitto%5Cconfig" target="_blank" rel="noopener"><span>tutorial</span></a><span> and </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Docker/mosquitto/commands.txt" target="_blank" rel="noopener"><span>cmds</span></a><span> for ubuntu if so wish to do something else. I added to the tutorial how to setup SSL in mqtt_connector_import.json file in mangentcenter to enable SSL, making the only service that requires port 1883 to be open is Helium.</span></p><p><strong><span>Node-RED:</span></strong><br>
<span>When it came to selecting a cloud platform, I opted for Node-RED. This choice was influenced by my familiarity with Node.js and my attraction to the block language for flow management. Node-RED allowed me to easily design and implement the necessary workflows and integrations within the IoT ecosystem.</span></p><p><span>In addition, Node-RED enables me to focus on flow creation by abstracting communication concepts by using nodes, such as MQTT, Telegram and influxdb. I did have to configure everything else myself, such as tables and measurements in influxdb, setting up the Telegram bot, and the topic tree for MQTT.</span></p><p><span>The first identified design pattern in Node-RED is the start, started and done state machine to create a responsiveness for the servers interface (Telgram).</span></p><p><span>On GitHub, you can find a file you can use to import the project onto your own Node-RED instance (You need to setup connection to your own MQTT, influxdb and Telegram connections).</span></p><p><strong><span>Getting Started:</span></strong><br>
<img src="https://hackmd.io/_uploads/Skya8Pmu3.png" alt="start" loading="lazy"><br>
<strong><span>Brewing:</span></strong><br>
<img src="https://hackmd.io/_uploads/SyeEUDmun.png" alt="brew" loading="lazy"><br>
<strong><span>Keep warm:</span></strong><br>
<img src="https://hackmd.io/_uploads/ByCUID7_n.png" alt="warm" loading="lazy"></p><p><strong><span>Server option:</span></strong><br>
<span>I would highly recommend using a Rasperbery Pi to host the platforms because of lower energy consumption. My monster of a desktop/Laptop consumes too much unneccessary energy, using Corsair RM850e 850W(Desktop) and 300W Lenovo(Laptop).</span></p><p><span>This server is designed with scalability in mind, allowing for easy configuration and integration into larger network systems, rather than being limited to a single device.</span></p><h2 id="Code" data-id="Code"><a class="anchor hidden-xs" href="#Code" title="Code"><span class="octicon octicon-link"></span></a><span class="ui-comment-inline-span">Code</span></h2><p><span>The complete source code can be found in </span><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project" target="_blank" rel="noopener"><span>my GitHub repository</span></a><span>. The code is structured into one main files:</span></p><p><span>Logic:</span></p><ul>
<li><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Pico/main.py" target="_blank" rel="noopener"><span>main.py</span></a></li>
</ul><p><span>Handlers(utils/):</span></p><ul>
<li><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Pico/utils/MQTTHandler.py" target="_blank" rel="noopener"><span>MQTTHandler.py</span></a></li>
<li><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Pico/utils/WiFiConnectionHandler.py" target="_blank" rel="noopener"><span>WiFiConnectionHandler.py</span></a></li>
<li><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Pico/utils/LoRaConnectionHandler.py" target="_blank" rel="noopener"><span>LoRaConnectionHandler.py</span></a></li>
<li><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Pico/utils/SensorHandler.py" target="_blank" rel="noopener"><span>SensorHandler.py</span></a></li>
<li><a href="https://github.com/Hadi-Saghir/1DT305_IoT_Project/blob/main/Pico/utils/ActuatorHandler.py" target="_blank" rel="noopener"><span>ActuatorHandler.py</span></a></li>
</ul><p><span>Keys:</span></p><ul>
<li><a href="http://secrets.py" target="_blank" rel="noopener"><span>secrets.py</span></a><span> (no link)</span></li>
</ul><p><span>In addition, there are some import libraries, which reside in a (lib/) directory and are:</span></p><ul>
<li><a href="https://pypi.org/project/micropython-umqtt.simple/" target="_blank" rel="noopener"><span>Micropython-umqtt.simple.py</span></a></li>
</ul><p><span>I identified design patterns that could promote reusability and scailability.</span></p><p><strong><span>Class diagram</span></strong><br>
<img src="https://hackmd.io/_uploads/BJMA0r3_2.png" alt="class diagram" loading="lazy"></p><pre><code>Start
|
|--&gt; Initialize Machine
|    |
|    |--&gt; Initialize WiFiHandler
|    |    |
|    |    |--&gt; Initialize connection
|    |    
|    |--&gt; Initialize MQTTHandler
|    |    |
|    |    |--&gt; Initialize MQTTClient
|    |
|    |--&gt; Initialize SensorHandler
|    |    |
|    |    |--&gt; Initialize Pins and ADC
|    |
|    |--&gt; Initialize ActuatorHandler
|
|--&gt; Set MQTT message handler
|
|--&gt; Loop
|    |
|    |--&gt; Check MQTT connection
|    |    |
|    |    |--&gt; Reconnect if not connected
|    |    |
|    |    |--&gt; Setup MQTT subscriptions
|    |    |
|    |--&gt; Check for incoming MQTT messages
|    |    |
|    |    |--&gt; Publish signal of acknowledgment
|    |    |
|    |    |--&gt; Handle message
|    |    |    |
|    |    |    |--&gt; Run brewing or warming process
|    |    |    |
|    |    |    |--&gt; Publish data
|    |    |
|    |    |--&gt; Publish signal of completion
|    |
|    |--&gt; Check for received commands
|    |    |
|    |    |--&gt; Increase command counter
|    |    |
|    |    |--&gt; Check command counter limit reached
|    |    |    |
|    |    |    |--&gt; Enter deep sleep 2 hour
|    |    |    
|    |--&gt; Check if it's night time
|    |    |
|    |    |--&gt; Enter deep sleep() 10 hour
|    |    |
|    |--&gt; Else 
|    |    | --&gt; Enter deep sleep() 20 mins
|    |
|
End

</code></pre><h2 id="Trasmitting-Data" data-id="Trasmitting-Data"><a class="anchor hidden-xs" href="#Trasmitting-Data" title="Trasmitting-Data"><span class="octicon octicon-link"></span></a><span>Trasmitting Data</span></h2><p><span>The data  is transmitted on a local network using a Wi-Fi  as the main connection. Wi-Fi was chosen as the wireless protocol due to its availability and compatibility with the existing infrastructure. I was able to setup LoRa by walking around and while LoRa would have been an energy-efficient option, its limited coverage in the project area made Wi-Fi the more practical choice. Despite this, this project has scaibility and flexibility in mind so both are configured.</span></p><p><span>To facilitate the data transmission, the project utilizes the MQTT (Message Queuing Telemetry Transport) protocol. MQTT is a lightweight and efficient messaging protocol designed for IoT applications. It allows for reliable and asynchronous communication between the IoT devices and the server, ensuring the delivery of messages even in unreliable network conditions. MQTT’s publish-subscribe model enables efficient data distribution, where the devices publish their data to specific topics, and the server or other subscribed clients receive the data from those topics. The data is trasmitted in the following frequency:</span></p><p><strong><span>Signaling data communication (initiated by user):</span></strong><span> (qos = 2)</span></p><ol>
<li><span>Signal is sent when </span><em><span>brewing starts</span></em><span> and when the </span><em><span>brewing is done</span></em><span>.</span></li>
<li><span>Signal is sent when </span><em><span>warming starts</span></em><span> and when the </span><em><span>warming is done</span></em><span>.</span></li>
</ol><p><strong><span>Readings is sent at specific events:</span></strong><span> (qos = 0)</span></p><ol>
<li><em><span>After brewing is done</span></em><span>, a temperature reading is sent to ensure coffee is brewing at the desired temperature.</span></li>
<li><em><span>During the coffee-warming phase</span></em><span>, temperature and humidity measurements of the coffee are sent every minute to monitor if its stays in the desired temperature.</span></li>
</ol><p><span>I have successfully configured SSL in my third draft to enable the utilization of TLS, effectively bolstering the security of our communication channels.</span></p><p><span>The choice of Wi-Fi and MQTT has implications for device range and battery consumption. Wi-Fi offers a relatively shorter range compared to other wireless protocols like LoRa. However, since the project is deployed in an area with Wi-Fi coverage, this limitation is mitigated. In terms of battery consumption, Wi-Fi tends to consume more energy compared to low-power protocols like LoRa. However, given the specific requirements of the project and the availability of Wi-Fi infrastructure, the trade-off between energy efficiency and connectivity convenience was made in favor of Wi-Fi.</span></p><p><strong><span>The code is available for LoRa and WiFi</span></strong><span> Make sure to import </span><code>utils/LoRaConnectionHandler.py</code><span> and adjust some comment/uncomment necessary lines:</span></p><pre><code>        temperature, humidity = self.sensor_handler.read(Sensor.DH11)
        #self.lora.pub_sensor_values("b", temperature, humidity)
        self.mqtt_handler.publish_message(b'brew/done', "Brew process completed")
        self.mqtt_handler.publish_message(b'brew/done/sensor/temp', str(temperature))
</code></pre><p><strong><span>Beware!</span></strong><span> LoRa is unit and integration tested, but not system tested. Testing was done in an earlier version (I honestly lost track from the amount of times i revised and refactored). I configured it in the park away from the project site (Home).</span></p><h2 id="Presenting-the-Data" data-id="Presenting-the-Data"><a class="anchor hidden-xs" href="#Presenting-the-Data" title="Presenting-the-Data"><span class="octicon octicon-link"></span></a><span>Presenting the Data</span></h2><p><strong><span>influxdb:</span></strong><br>
<span>To store and manage the collected data, influxDB will be utilized as the database solution. influxDB excels in handling time-series data, making it a perfect fit for this IoT project. It provides efficient storage and retrieval of time-stamped data points. This will allow me with ease to retreive data on temperature through time to see if the coffee is being brewed at optimal temperature. In addition, it is compatiable with Node-RED. The following trigger is used in the following scenarios mention above:</span></p><ol>
<li><em><span>After brewing is done</span></em><span>, a temperature reading is sent to ensure coffee is brewing at the desired temperature.</span></li>
<li><em><span>During the coffee-warming phase</span></em><span>, temperature and humidity measurements of the coffee are sent every minute to monitor if its stays in the desired temperature.</span></li>
</ol><p><img src="https://hackmd.io/_uploads/r10Ag8cd3.png" alt="trigger" loading="lazy"></p><p><span>The length of retention is set to 1 year in docker-compose.yml file:</span><br>
<code>DOCKER_INFLUXDB_INIT_RETENTION=365d</code></p><p><span>influxdb uses its own query language, which is different from the most popular query languages, and takes some time to learn.</span></p><pre><code>from(bucket: "brew")
  |&gt; range(start: 0)
  |&gt; filter(fn: (r) =&gt; r._measurement == "temp")
</code></pre><p><img src="https://hackmd.io/_uploads/rk9bj8hdn.png" alt="influxdb" loading="lazy"></p><p><strong><span>Grafana</span></strong><br>
<span>Grafana is chosen as the visualization and monitoring tool for the IoT project due to its compatibility with InfluxDB, the selected database solution. Its native integration with InfluxDB ensures seamless data retrieval and visualization, enabling a smooth workflow when working with time-series data. I didn’t scrutinize other option as I primarly want to visualize things on Telegram for convenience.</span></p><p><img src="https://hackmd.io/_uploads/r1YIbgZFn.png" alt="Grafana" loading="lazy"></p><p><strong><span>Telegram:</span></strong><br>
<span>Lastly, I utilized Telegram bots for remote control of the coffee machine and data visualization. I preferred Telegram over other messaging platforms, such as Discord, due to its simplicity and user-friendly UI. Having Telegram installed on my phone allowed me to conveniently monitor and interact with the IoT system from anywhere.</span></p><p><span>Flow</span></p><p><img src="https://hackmd.io/_uploads/By1CbUqdn.png" alt="trigger" loading="lazy"><br>
<span>Chat</span></p><p><img src="https://hackmd.io/_uploads/SJnPSstd2.png" alt="Telegram" loading="lazy"></p><h1 id="Finalizing-the-Design-amp-Reflections" data-id="Finalizing-the-Design-amp-Reflections"><a class="anchor hidden-xs" href="#Finalizing-the-Design-amp-Reflections" title="Finalizing-the-Design-amp-Reflections"><span class="octicon octicon-link"></span></a><span>Finalizing the Design &amp; Reflections</span></h1><p><span>The IoT Coffee Brewing System project has been successfully implemented, resulting in a smart and automated coffee brewing solution from the convenience of a Telegram. The system combines various sensors, connectivity options, and two user-friendly interface to enhance the coffee making experience.</span></p><p><strong><span>Key Features:</span></strong></p><ol>
<li>
<p><span>Wireless Monitoring: The system allows individuals to monitor the temperature and the humidity of the coffee brewing temperature and warming. Users can conveniently check the status of their coffee from anywhere.</span></p>
</li>
<li>
<p><span>Remote control: The system allows individuals to control their coffee machine using Telegram. You can brew coffee and turn of the machine once done to save energy. You can keep the coffee warm for as long as you want.</span></p>
</li>
<li>
<p><span>More control: The system allows user more options such as scheduling and timers to when you want to have your coffee and specified durations to keep your coffee warm</span></p>
</li>
<li>
<p><span>Energy efficiency: Once the brewing process is complete, an alert is sent to the user’s mobile device and the machine is turned automatically off for energy saving.</span></p>
</li>
<li>
<p><span>Intuitive visualization of data: A user-friendly dashboard for in-depth monitoring, but allows for the  convenience of seeing the information anywhere you want using Telegram</span></p>
</li>
</ol><h2 id="Photos" data-id="Photos"><a class="anchor hidden-xs" href="#Photos" title="Photos"><span class="octicon octicon-link"></span></a><span>Photos</span></h2><p><img src="https://hackmd.io/_uploads/ByFBiDh_n.jpg" alt="Photo resistor uncovered" loading="lazy"><br>
<img src="https://hackmd.io/_uploads/HJYHiw2_n.jpg" alt="w LoRa" loading="lazy"><br>
<img src="https://hackmd.io/_uploads/r1FSivnOh.jpg" alt="w Lora" loading="lazy"><br>
<img src="https://hackmd.io/_uploads/SyYSovn_h.jpg" alt="bird view" loading="lazy"></p><h2 id="Video-Presentation" data-id="Video-Presentation"><a class="anchor hidden-xs" href="#Video-Presentation" title="Video-Presentation"><span class="octicon octicon-link"></span></a><span>Video Presentation</span></h2><p><a href="https://www.youtube.com/watch?v=c63xlWkW_jY" target="_blank" rel="noopener"><span>Link to Youtube video</span></a></p><h2 id="Overall-Assessment" data-id="Overall-Assessment"><a class="anchor hidden-xs" href="#Overall-Assessment" title="Overall-Assessment"><span class="octicon octicon-link"></span></a><span>Overall Assessment</span></h2><p><span>This project helped me learn a couple of valuable skills, and I’m really happy with the results. Here are some of the key things I learned:</span></p><ul>
<li><span>I learned how to use </span><strong><span>Docker</span></strong><span> and gained proficiency in writing Docker Compose files.</span></li>
<li><span>I deepened my </span><strong><span>understanding of networks</span></strong><span>, including the concepts of frequencies, bandwidth, ports and security. I also learned how to create bridges in Docker.</span></li>
<li><span>I learned how to effectively use </span><strong><span>Pub/Sub</span></strong><span>.</span></li>
<li><strong><span>locally-hosting</span></strong><span> on Docker was a fascinating and rewarding experience.</span></li>
<li><span>I gained </span><strong><span>practical knowledge</span></strong><span> in working with sensors and actuators.</span></li>
<li><span>I realized the importance of </span><strong><span>energy efficiency</span></strong><span> in making IoT a prominent feature of the future.</span></li>
</ul><h2 id="Areas-for-Improvement-I-wished-to-implement" data-id="Areas-for-Improvement-I-wished-to-implement"><a class="anchor hidden-xs" href="#Areas-for-Improvement-I-wished-to-implement" title="Areas-for-Improvement-I-wished-to-implement"><span class="octicon octicon-link"></span></a><span>Areas for Improvement I wished to implement</span></h2><ol>
<li>
<p><strong><span>More appropriate sensors:</span></strong><span> The DH11 does not measure the temperature of the coffee accurately. The photo resistor needed to be configured using software and the hardware needed to be in an isolated environment. Proving an ugly, constrictive appendage on the dimly lit start button that isn’t fool proof (100% accurate). It was the only sensor available to able to work around not ruining the coffee machine and getting evicted.</span></p>
</li>
<li>
<p><strong><span>Enhanced energy efficiency:</span></strong><span> While the current implementation utilizes Wi-Fi connectivity, exploring power-efficient alternatives like LoRaWAN relay module with extended range could further optimize energy consumption, particularly in scenarios where Wi-Fi coverage is limited.</span></p>
</li>
<li>
<p><strong><span>Integration with voice assistants:</span></strong><span> Integrating the system with popular voice assistants like Amazon Alexa or Google Assistant would provide additional convenience and hands-free control options for users. I don’t own one but i see how voice assistants can be used now with this smart coffee machine. However, it is too costly for me.</span></p>
</li>
<li>
<p><strong><span>Using script:</span></strong><span> Scripts are very powerful tools for automating deployment and configuration. For example, using cmd such as </span><code>influx bucket create -n brew -r 365d -o hadsag</code><span>, i can automate setup of influxdb. This elimiates risk of miscommunication.</span></p>
</li>
</ol></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav">
<li><a href="#Introduction" title="Introduction">Introduction</a><ul class="nav">
<li><a href="#Objective" title="Objective:">Objective:</a></li>
</ul>
</li>
<li><a href="#Getting-Started" title="Getting Started">Getting Started</a><ul class="nav">
<li><a href="#Material" title="Material">Material</a></li>
<li><a href="#Computer-setup" title="Computer setup">Computer setup</a></li>
</ul>
</li>
<li><a href="#Assembly" title="Assembly">Assembly</a><ul class="nav">
<li><a href="#Putting-Everything-Together" title="Putting Everything Together">Putting Everything Together</a></li>
<li><a href="#Platform" title="Platform">Platform</a></li>
<li><a href="#Code" title="Code">Code</a></li>
<li><a href="#Trasmitting-Data" title="Trasmitting Data">Trasmitting Data</a></li>
<li><a href="#Presenting-the-Data" title="Presenting the Data">Presenting the Data</a></li>
</ul>
</li>
<li><a href="#Finalizing-the-Design-amp-Reflections" title="Finalizing the Design &amp; Reflections">Finalizing the Design &amp; Reflections</a><ul class="nav">
<li><a href="#Photos" title="Photos">Photos</a></li>
<li><a href="#Video-Presentation" title="Video Presentation">Video Presentation</a></li>
<li><a href="#Overall-Assessment" title="Overall Assessment">Overall Assessment</a></li>
<li><a href="#Areas-for-Improvement-I-wished-to-implement" title="Areas for Improvement I wished to implement">Areas for Improvement I wished to implement</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;" null null>
        <div class="toc"><ul class="nav">
<li><a href="#Introduction" title="Introduction">Introduction</a><ul class="nav">
<li><a href="#Objective" title="Objective:">Objective:</a></li>
</ul>
</li>
<li><a href="#Getting-Started" title="Getting Started">Getting Started</a><ul class="nav">
<li><a href="#Material" title="Material">Material</a></li>
<li><a href="#Computer-setup" title="Computer setup">Computer setup</a></li>
</ul>
</li>
<li><a href="#Assembly" title="Assembly">Assembly</a><ul class="nav">
<li><a href="#Putting-Everything-Together" title="Putting Everything Together">Putting Everything Together</a></li>
<li><a href="#Platform" title="Platform">Platform</a></li>
<li><a href="#Code" title="Code">Code</a></li>
<li><a href="#Trasmitting-Data" title="Trasmitting Data">Trasmitting Data</a></li>
<li><a href="#Presenting-the-Data" title="Presenting the Data">Presenting the Data</a></li>
</ul>
</li>
<li><a href="#Finalizing-the-Design-amp-Reflections" title="Finalizing the Design &amp; Reflections">Finalizing the Design &amp; Reflections</a><ul class="nav">
<li><a href="#Photos" title="Photos">Photos</a></li>
<li><a href="#Video-Presentation" title="Video Presentation">Video Presentation</a></li>
<li><a href="#Overall-Assessment" title="Overall Assessment">Overall Assessment</a></li>
<li><a href="#Areas-for-Improvement-I-wished-to-implement" title="Areas for Improvement I wished to implement">Areas for Improvement I wished to implement</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
